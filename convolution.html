<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8"/>
		<meta http-equiv="X-UA-Compatible" content="IE=Edge">
		<title>Edge Detection with Canvas</title>
		<style>
			cavas{
				margin:5px;
				border:1px solid #ccc;
				display:block;
				float:left;
				background-color:#eee;
			}
		</style>
	</head>
	<body>
		
		<button onclick="renderOutput();">Render Output</button> <br /><br />
		
		<span style="display:none">
			<input type="text" id="tolerance"  name="tolerance" value="12" style="width:20px;"> Tolerance: (0-100)<br />
			<input type="text" id="levels"  name="levels" value="0" style="width:20px;"> Levels Enhancement: (contrast increase) <br />
			<input type="text" id="offset"  name="offset" value="2" style="width:20px;"> Pixel Offset: (size of line) <br /><br />
		</span>
		
		<canvas id="imageCanvas" width="150" height="150"> </canvas>
		<canvas id="resultimageCanvas" width="150" height="150"> </canvas>
		
		<script>
			var img = new Image();
			img.src="p3.jpg";
		
			var canvas = document.getElementById('imageCanvas');
			var ctx = canvas.getContext('2d');
			var outputCanvas = document.getElementById('resultimageCanvas');
			var ctxOutput = outputCanvas.getContext('2d');
			var imageData = [];
			var diffImage = [];
		
			var imgData = null;
			var width = 150;
			var height = 150;
			var pixelOffset = 0;
			var levels = 0;
			var tolerance = 0;
			
			var blurKernel = 
			[
			  [1,1,1],
			  [1,1,1],
			  [1,1,1]			
			];
			
			var edgeKernel = 
			[
			  [-1,-1,-1],
			  [-1,8,-1],
			  [-1,1,-1]				
			];
			
			var sharpenKernel = 
			[
			  [0,-1,0],
			  [-1,5,-1],
			  [0,-1,0]			
			];
			
			
			img.onload = function(){
				var x = 0;
				var y = 0;
				ctx.drawImage(img, 0, 0);
			};
			
			var renderOutput = function(){
				//grab all the image data....
				for(var y = 0; y< height; y++){
					if(imageData[y] == undefined) imageData[y] = [];
					for(x = 0; x < width; x++){
						var pixel = ctx.getImageData(x, y, 1, 1);
						if(imageData[x] == undefined) imageData[x] = [];
						imageData[x][y] = pixel;
					}
				}
				
				//apply the correct kernerl convolution effect
				var kernel = sharpenKernel; //use the blur kernel
				var errors = 0;
				for(var y = 0; y < height; y++){
					for(x = 0; x < width; x++){
						
						//check to make sure that the pixel exists, otherwise do not use it
						//we're using a 3x3 matrix so only 9 cycles for each pixel
						var cord = {};
						var pixelVal = [0,0,0];
						for(i=0; i<3; i++){
							cord.y = y + i -1;
							
							for(j=0; j<3; j++){
								cord.x = x + j - 1;
								
								try{
									var tempPixel = imageData[cord.x][cord.y];
									
									if(tempPixel != undefined){
										var r = tempPixel.data[0];
										var g = tempPixel.data[1];
										var b = tempPixel.data[2];
										
										pixelVal[0] += kernel[j][i] * r;
										pixelVal[1] += kernel[j][i] * g;
										pixelVal[2] += kernel[j][i] * b;  
									}
								}catch(error){
									//console.log("pixel does not exist at " + cord.x + "," + cord.y);
								}
							}
						}
						
						pixelVal[0] = Math.ceil(pixelVal[0]/9);
						pixelVal[1] = Math.ceil(pixelVal[1]/9);
						pixelVal[2] = Math.ceil(pixelVal[2]/9);
						
						color1D = 'rgb(' + imageData[x][y].data[0] + ',' + imageData[x][y].data[1] + ',' + imageData[x][y].data[2] + ')';
						colorBlur = 'rgb(' + pixelVal[0] + ',' + pixelVal[1] + ',' + pixelVal[2] + ')';
						ctxOutput.fillStyle = colorBlur;
					    ctxOutput.fillRect(x,y,1,1);
					}
				}
			};
			
		</script>
	</body>
</html>
